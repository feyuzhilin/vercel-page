import{m as P,n as O,o as V,q as z,r as H,t as R,u as G,v as w,x as U,y as A,z as k,s as T,A as W,V as _,C as j,E as N}from"./index.ac2cf653.js";import{b as q}from"./computeBVH.b89f793d.js";const y=new Set,F=()=>new WeakSet;P(function(){if(H())return;const s=O();if(!s.length)return;const c=V(),b=z(),h=.02,C=R(()=>{G.clear();for(const t of y){const a=t.bvhVelocity,o=t.outerObject3d,v=t.bvhHalfHeight,n=t.bvhRadius;a.y+=t.bvhOnGround?0:h*-c;const{position:r}=t.physicsUpdate;t.physicsUpdate={},r&&(r.x&&(a.x=0),r.y&&(a.y=0),r.z&&(a.z=0)),o.position.addScaledVector(a,h),o.updateMatrixWorld();const{start:i,end:l}=A;l.copy(i.copy(o.position));const m=Math.max(v-n,0);l.y+=m,i.y-=m;const B=i.clone();w.setFromCenterAndSize(o.position,U.set(n*2,v*2,n*2));const g=j,M=N;let d=0,p,S=!1,u;for(const x of s)u=q.get(x),x.shapecast({intersectsBounds:f=>f.intersectsBox(w),intersectsTriangle:f=>{d=f.closestPointToSegment(A,g,M),d<n&&(S=!0,p=M.sub(g).normalize().multiplyScalar(n-d),i.add(p),l.add(p))}});S&&u&&k(G,t,F).add(u);const e=i.sub(B);t.bvhOnGround=e.y>Math.abs(h*a.y*.25),b&&t.bvhOnGround&&Math.abs(e.y/(e.x+e.z+Number.EPSILON))<b&&(t.bvhOnGround=!1);const E=Math.max(0,e.length()-1e-5);e.normalize().multiplyScalar(E),o.position.add(e),t.bvhOnGround?a.set(0,0,0):(e.normalize(),a.addScaledVector(e,-e.dot(a)))}});return()=>{C.cancel()}},[O,V,z,H]);function D(s){if(s.done)return;T.attach(this.outerObject3d),this.width=this.depth=Math.min(this.width,this.depth),this.physicsUpdate={};const c=W(this).multiplyScalar(.5);this.bvhHalfHeight=Math.max(c.y,.5),this.bvhRadius=Math.max(c.x,.5),this.bvhVelocity=new _,y.add(this),s.then(()=>{y.delete(this),this.physicsUpdate=void 0})}export{D as default};
